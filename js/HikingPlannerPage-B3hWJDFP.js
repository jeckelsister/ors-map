import{c as _,j as e,T as pe,C as fe,u as be}from"./index-CuNe8dY9.js";import{r as g,R as ye}from"./router-thpCtGxH.js";import{a as X,b as ve,c as je,d as K,e as se,f as Ne,g as we,h as ke,i as $e,j as Se,k as Me,l as Pe,m as ne,n as Re,o as re,p as Ce,q as Ee,r as G}from"./icons-DQM9_izd.js";import{k as O,i as De,L,M as Ie,l as Ae,N as Te,m as Le,n as Fe}from"./Navigation-Dkb4EvuO.js";import{u as We,C as Oe,a as _e,b as Y,D as ze,c as qe,S as Ge,v as Xe,d as Be,s as Ue,K as He,P as Ve}from"./dnd-BgMrr-QX.js";import"./vendor-gH-7aFTg.js";import"./leaflet-BloEYaw0.js";import"./Logo-CG7twSBP.js";/**
 * @license lucide-react v0.539.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ze=[["path",{d:"M12 15V3",key:"m9g1x1"}],["path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4",key:"ih7n3h"}],["path",{d:"m7 10 5 5 5-5",key:"brsn70"}]],Qe=_("download",Ze);/**
 * @license lucide-react v0.539.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ke=[["path",{d:"M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z",key:"1rqfz7"}],["path",{d:"M14 2v4a2 2 0 0 0 2 2h4",key:"tnqrlb"}],["path",{d:"M10 9H8",key:"b1mrlr"}],["path",{d:"M16 13H8",key:"t4e002"}],["path",{d:"M16 17H8",key:"z1uh3a"}]],Ye=_("file-text",Ke);/**
 * @license lucide-react v0.539.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Je=[["path",{d:"M20 10c0 4.993-5.539 10.193-7.399 11.799a1 1 0 0 1-1.202 0C9.539 20.193 4 14.993 4 10a8 8 0 0 1 16 0",key:"1r0f0z"}],["circle",{cx:"12",cy:"10",r:"3",key:"ilqhr7"}]],et=_("map-pin",Je);/**
 * @license lucide-react v0.539.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const tt=[["path",{d:"M4.5 16.5c-1.5 1.26-2 5-2 5s3.74-.5 5-2c.71-.84.7-2.13-.09-2.91a2.18 2.18 0 0 0-2.91-.09z",key:"m3kijz"}],["path",{d:"m12 15-3-3a22 22 0 0 1 2-3.95A12.88 12.88 0 0 1 22 2c0 2.72-.78 7.5-6 11a22.35 22.35 0 0 1-4 2z",key:"1fmvmk"}],["path",{d:"M9 12H4s.55-3.03 2-4c1.62-1.08 5 0 5 0",key:"1f8sc4"}],["path",{d:"M12 15v5s3.03-.55 4-2c1.08-1.62 0-5 0-5",key:"qeys4"}]],J=_("rocket",tt);/**
 * @license lucide-react v0.539.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const st=[["path",{d:"M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8",key:"1357e3"}],["path",{d:"M3 3v5h5",key:"1xhq8a"}]],nt=_("rotate-ccw",st);/**
 * @license lucide-react v0.539.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const rt=[["path",{d:"M12 3v12",key:"1x0j5s"}],["path",{d:"m17 8-5-5-5 5",key:"7q97r8"}],["path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4",key:"ih7n3h"}]],ae=_("upload",rt);function at({route:t,height:s=200,showStages:n=!0}){const{pathData:a,markers:r,stats:o}=g.useMemo(()=>{if(!t)return{pathData:"",markers:[],stats:null};let l=[],x=0;const u=[];if(t.stages.forEach((d,S)=>{S>0&&u.push({distance:x,name:d.name});const E=d.elevationProfile.map(I=>({...I,distance:x+I.distance}));l=[...l,...E],x+=d.distance}),l.length===0)return{pathData:"",markers:[],stats:null};const m=350,i={top:20,right:20,bottom:40,left:50},f=m-i.left-i.right,h=s-i.top-i.bottom,c=Math.max(...l.map(d=>d.distance)),v=Math.min(...l.map(d=>d.elevation)),k=Math.max(...l.map(d=>d.elevation)),N=(k-v)*.1,M=v-N,C=k+N,b=l.map((d,S)=>{const E=i.left+d.distance/c*f,I=i.top+h-(d.elevation-M)/(C-M)*h;return`${S===0?"M":"L"} ${E} ${I}`}).join(" ")+` L ${i.left+f} ${i.top+h} L ${i.left} ${i.top+h} Z`,j=n?u.map(d=>({...d,x:i.left+d.distance/c*f})):[],w={totalDistance:t.totalDistance,totalAscent:t.totalAscent,totalDescent:t.totalDescent,minElevation:t.minElevation,maxElevation:t.maxElevation,elevationGain:t.maxElevation-t.minElevation};return{pathData:b,markers:j,stats:w,chartInfo:{width:m,height:s,padding:i,chartWidth:f,chartHeight:h,maxDistance:c,minElevation:M,maxElevation:C}}},[t,s,n]);return!t||!o?e.jsx("div",{className:"p-4 bg-gray-50 rounded-lg border border-gray-200",children:e.jsxs("div",{className:"flex items-center gap-2 text-gray-500",children:[e.jsx(X,{className:"w-4 h-4"}),e.jsx("span",{className:"text-sm",children:"Créez un itinéraire pour voir le profil altimétrique"})]})}):e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"bg-green-50 border border-green-200 rounded-lg p-3",children:[e.jsxs("div",{className:"flex items-center gap-2 text-green-700",children:[e.jsx(ve,{className:"w-3 h-3"}),e.jsx("span",{className:"text-xs font-medium",children:"Dénivelé +"})]}),e.jsxs("div",{className:"text-lg font-bold text-green-800",children:[o.totalAscent,"m"]})]}),e.jsxs("div",{className:"bg-red-50 border border-red-200 rounded-lg p-3",children:[e.jsxs("div",{className:"flex items-center gap-2 text-red-700",children:[e.jsx(je,{className:"w-3 h-3"}),e.jsx("span",{className:"text-xs font-medium",children:"Dénivelé -"})]}),e.jsxs("div",{className:"text-lg font-bold text-red-800",children:[o.totalDescent,"m"]})]})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-2 text-xs",children:[e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"font-medium text-gray-700",children:"Distance"}),e.jsxs("div",{className:"text-blue-600 font-bold",children:[o.totalDistance.toFixed(1)," km"]})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"font-medium text-gray-700",children:"Alt. min"}),e.jsxs("div",{className:"text-purple-600 font-bold",children:[o.minElevation,"m"]})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"font-medium text-gray-700",children:"Alt. max"}),e.jsxs("div",{className:"text-orange-600 font-bold",children:[o.maxElevation,"m"]})]})]}),e.jsxs("div",{className:"bg-white border border-gray-200 rounded-lg p-2 overflow-x-auto",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(X,{className:"w-4 h-4 text-gray-600"}),e.jsx("span",{className:"text-sm font-medium text-gray-700",children:"Profil altimétrique"})]}),e.jsx("div",{className:"relative",children:e.jsxs("svg",{width:"350",height:s,className:"w-full",children:[e.jsx("defs",{children:e.jsx("pattern",{id:"grid",width:"20",height:"20",patternUnits:"userSpaceOnUse",children:e.jsx("path",{d:"M 20 0 L 0 0 0 20",fill:"none",stroke:"#f3f4f6",strokeWidth:"1"})})}),e.jsx("rect",{width:"100%",height:"100%",fill:"url(#grid)"}),e.jsx("path",{d:a,fill:"url(#elevationGradient)",stroke:"#3b82f6",strokeWidth:"2",opacity:"0.8"}),e.jsx("defs",{children:e.jsxs("linearGradient",{id:"elevationGradient",x1:"0%",y1:"0%",x2:"0%",y2:"100%",children:[e.jsx("stop",{offset:"0%",stopColor:"#3b82f6",stopOpacity:"0.6"}),e.jsx("stop",{offset:"100%",stopColor:"#3b82f6",stopOpacity:"0.1"})]})}),r.map((l,x)=>e.jsxs("g",{children:[e.jsx("line",{x1:l.x,y1:"20",x2:l.x,y2:s-40,stroke:"#ef4444",strokeWidth:"1",strokeDasharray:"4,4",opacity:"0.7"}),e.jsxs("text",{x:l.x,y:"15",fontSize:"10",fill:"#ef4444",textAnchor:"middle",className:"font-medium",children:["E",x+2]})]},x)),e.jsxs("text",{x:"15",y:"25",fontSize:"10",fill:"#6b7280",textAnchor:"middle",children:[o.maxElevation,"m"]}),e.jsxs("text",{x:"15",y:s-45,fontSize:"10",fill:"#6b7280",textAnchor:"middle",children:[o.minElevation,"m"]}),e.jsx("text",{x:"50",y:s-10,fontSize:"10",fill:"#6b7280",textAnchor:"start",children:"0 km"}),e.jsxs("text",{x:"320",y:s-10,fontSize:"10",fill:"#6b7280",textAnchor:"end",children:[o.totalDistance.toFixed(1)," km"]})]})})]}),n&&r.length>0&&e.jsxs("div",{className:"text-xs text-gray-600 bg-gray-50 p-2 rounded",children:[e.jsx("div",{className:"font-medium mb-1",children:"Légende :"}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("div",{className:"w-3 h-0.5 bg-blue-500"}),e.jsx("span",{children:"Profil"})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("div",{className:"w-3 h-0.5 border-t border-red-500 border-dashed"}),e.jsx("span",{children:"Étapes"})]})]})]})]})}const le="eyJvcmciOiI1YjNjZTM1OTc4NTExMTAwMDFjZjYyNDgiLCJpZCI6IjEyYTBhMTVhZmE0ZGI1N2E5NzgyMzkyOWQyMjIxZTVmMWMzODFkM2I5Njg3ZTE2ZTMyNDA3ZDA2IiwiaCI6Im11cm11cjY0In0=",oe="https://overpass-api.de/api/interpreter",ie="https://api.openrouteservice.org",lt=t=>{if(!t)return{profile:"foot-hiking",options:{}};const{preferences:s}=t,n="foot-hiking";let a={};return s.preferOfficial&&!s.allowUnofficial?a={avoid_features:["steps","ferries"]}:s.preferOfficial&&s.allowUnofficial?a={avoid_features:["ferries"]}:s.noPreference?a={avoid_features:[]}:a={avoid_features:["ferries"]},{profile:n,options:a}},ot=async()=>{try{await O.post(`${ie}/v2/directions/foot-hiking/geojson`,{coordinates:[[2.3522,48.8566],[2.2945,48.8584]]},{headers:{Authorization:le,"Content-Type":"application/json"},timeout:1e4})}catch{}};ot();const it=async t=>{let s=t;if(s.length>200){const n=Math.ceil(s.length/200);s=s.filter((a,r)=>r%n===0),s[s.length-1]!==t[t.length-1]&&s.push(t[t.length-1])}try{const a=(await O.post("https://api.open-elevation.com/api/v1/lookup",{locations:s.map(([l,x])=>({latitude:x,longitude:l}))})).data.results,r=[];let o=0;for(let l=0;l<a.length;l++){const x=a[l];if(l>0){const u=s[l-1],m=s[l],i=z([u[1],u[0]],[m[1],m[0]]);o+=i}r.push({distance:o,elevation:Math.round(x.elevation),lat:x.latitude,lng:x.longitude})}return r}catch{throw new Error("Impossible de calculer le profil altimétrique")}},z=(t,s)=>{const a=q(s[0]-t[0]),r=q(s[1]-t[1]),o=q(t[0]),l=q(s[0]),x=Math.sin(a/2)*Math.sin(a/2)+Math.sin(r/2)*Math.sin(r/2)*Math.cos(o)*Math.cos(l);return 6371*(2*Math.atan2(Math.sqrt(x),Math.sqrt(1-x)))},q=t=>t*Math.PI/180,ct=(t,s)=>{if(s<=1||!t.stages||t.stages.length===0)return t;const n=t.stages[0];if(!n.geojson?.features?.[0]?.geometry)return t;const a=n.geojson.features[0].geometry;if(a.type!=="LineString")return t;const r=a.coordinates;if(r.length<2)return t;const o=[0];let l=0;for(let m=1;m<r.length;m++){const i=z([r[m-1][1],r[m-1][0]],[r[m][1],r[m][0]]);l+=i,o.push(l)}const x=l/s,u=[];for(let m=0;m<s;m++){const i=m*x,f=(m+1)*x,h=ee(o,i),c=m===s-1?r.length-1:ee(o,f),v=r.slice(h,c+1);if(v.length<2)continue;const k=dt(v),N={type:"FeatureCollection",features:[{type:"Feature",geometry:{type:"LineString",coordinates:v},properties:{summary:{distance:x*1e3,duration:k.distance*900}}}]},M=v.map((C,p)=>({distance:k.distance/v.length*p,elevation:1200+Math.sin(p*.1)*200,lat:C[1],lng:C[0]}));u.push({id:`stage_auto_${Date.now()}_${m+1}`,name:`Étape ${m+1}`,startPoint:{lat:v[0][1],lng:v[0][0],id:`start_${m+1}`,name:`Début étape ${m+1}`},endPoint:{lat:v[v.length-1][1],lng:v[v.length-1][0],id:`end_${m+1}`,name:`Fin étape ${m+1}`},distance:k.distance,ascent:k.ascent,descent:k.descent,estimatedTime:Math.round(k.distance*15),elevationProfile:M,geojson:N})}return{...t,stages:u,totalDistance:l,totalAscent:u.reduce((m,i)=>m+i.ascent,0),totalDescent:u.reduce((m,i)=>m+i.descent,0)}},ee=(t,s)=>{for(let n=0;n<t.length-1;n++)if(t[n]<=s&&t[n+1]>=s){const a=Math.abs(t[n]-s),r=Math.abs(t[n+1]-s);return a<=r?n:n+1}return t.length-1},dt=t=>{let s=0,n=0,a=0;for(let r=1;r<t.length;r++){const o=z([t[r-1][1],t[r-1][0]],[t[r][1],t[r][0]]);s+=o;const l=(t[r][1]-t[r-1][1])*111e3*.01;l>0?n+=Math.abs(l):a+=Math.abs(l)}return{distance:s,ascent:Math.round(n),descent:Math.round(a)}},mt=async(t,s,n=1,a)=>{try{const r=s?[...t,t[0]]:t,o=[];let l=0,x=0,u=0,m=1/0,i=-1/0;const f=Math.max(2,Math.ceil(r.length/n));for(let c=0;c<n;c++){const v=c*(f-1),k=Math.min(v+f,r.length);if(v>=r.length-1)break;const N=r.slice(v,k),M=await ut(`Étape ${c+1}`,N,a);o.push(M),l+=M.distance,x+=M.ascent,u+=M.descent,m=Math.min(m,...M.elevationProfile.map(C=>C.elevation)),i=Math.max(i,...M.elevationProfile.map(C=>C.elevation))}const h=[];return o.forEach(c=>{c.geojson.features&&h.push(...c.geojson.features)}),{id:`route_${Date.now()}`,name:s?"Itinéraire en boucle":"Itinéraire linéaire",type:s?"loop":"point-to-point",stages:o,totalDistance:Math.round(l*100)/100,totalAscent:Math.round(x),totalDescent:Math.round(u),minElevation:Math.round(m),maxElevation:Math.round(i),geojson:{type:"FeatureCollection",features:h}}}catch{throw new Error("Impossible de créer l'itinéraire de randonnée")}},ut=async(t,s,n)=>{if(s.length<2)throw new Error("Au moins 2 points sont nécessaires pour créer une étape");const a=s[0],r=s[s.length-1],o=s.map(u=>[u.lng,u.lat]),{profile:l,options:x}=lt(n);try{const u={coordinates:o};Object.keys(x).length>0&&(u.options=x);const m=await O.post(`${ie}/v2/directions/${l}/geojson`,u,{headers:{Authorization:le,"Content-Type":"application/json"},timeout:3e4}),i=m.data.features[0].geometry,f=m.data.features[0].properties.summary,h=await it(i.coordinates);let c=0,v=0;for(let k=1;k<h.length;k++){const N=h[k].elevation-h[k-1].elevation;N>0?c+=N:v-=N}return{id:`stage_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,name:t,startPoint:a,endPoint:r,distance:Math.round(f.distance/1e3*100)/100,ascent:Math.round(c),descent:Math.round(v),estimatedTime:Math.round(f.duration/60),elevationProfile:h,geojson:m.data}}catch(u){if(O.isAxiosError(u)){if(u.response?.status===401)throw new Error("❌ Clé API OpenRouteService invalide. Vérifiez votre configuration.");if(u.response?.status===403)throw new Error("❌ Quota API dépassé ou accès refusé.");if(u.response?.status===400)throw new Error("❌ Paramètres de requête invalides. Vérifiez les coordonnées.");if(u.response?.status===404)throw new Error("❌ Impossible de calculer un itinéraire entre ces points.");if(u.code==="ERR_NETWORK")throw new Error("❌ Problème de connexion réseau. Vérifiez votre connexion internet.")}throw new Error(`❌ Erreur API: ${u instanceof Error?u.message:"Erreur inconnue"}`)}},ce=(t,s,n)=>{let a=1/0;for(let r=0;r<n.length-1;r++){const o=[n[r][1],n[r][0]],l=[n[r+1][1],n[r+1][0]],x=ht([t,s],o,l);a=Math.min(a,x)}return a},ht=(t,s,n)=>{const[a,r]=t,[o,l]=s,[x,u]=n,m=x-o,i=u-l;if(m===0&&i===0)return z(t,s);const f=Math.max(0,Math.min(1,((a-o)*m+(r-l)*i)/(m*m+i*i))),h=o+f*m,c=l+f*i;return z(t,[h,c])},de=async(t,s=2,n=1e3)=>{for(let a=0;a<s;a++)try{return await t()}catch(r){const o=a===s-1,l=r instanceof Error&&(r.message.includes("504")||r.message.includes("timeout"));if(o||!l)throw r;await new Promise(x=>setTimeout(x,n*Math.pow(2,a)))}throw new Error("Max retries exceeded")},xt=async(t,s=5)=>{try{const n=t.features[0];if(!n||n.geometry.type!=="LineString")throw new Error("Route invalide");const a=n.geometry.coordinates,r=a.map(c=>c[1]),o=a.map(c=>c[0]),l=Math.min(...r),x=Math.max(...r),u=Math.min(...o),m=Math.max(...o),i=s/111;return(await de(async()=>{const c=`
        [out:json][timeout:8];
        (
          node["tourism"="alpine_hut"](${l-i},${u-i},${x+i},${m+i});
          node["tourism"="wilderness_hut"](${l-i},${u-i},${x+i},${m+i});
        );
        out geom;
      `;return await O.post(oe,c,{headers:{"Content-Type":"text/plain"},timeout:1e4})},2,1e3)).data.elements.map(c=>({id:c.id.toString(),name:c.tags.name||"Refuge sans nom",type:gt(c.tags),lat:c.lat,lng:c.lon,elevation:c.tags.ele?parseInt(c.tags.ele):0,capacity:c.tags.capacity?parseInt(c.tags.capacity):void 0,open_season:c.tags.opening_hours,contact:c.tags.phone||c.tags.website,services:pt(c.tags)})).filter(c=>ce(c.lat,c.lng,a)<=s)}catch{return[]}},gt=t=>t.tourism==="alpine_hut"&&t.operator?"gardé":t.amenity==="shelter"?"bivouac":"libre",pt=t=>{const s=[];return t.restaurant==="yes"&&s.push({type:"meals",available:!0}),t.shower==="yes"&&s.push({type:"shower",available:!0}),t.internet_access==="yes"&&s.push({type:"wifi",available:!0}),s},ft=async(t,s=2)=>{try{const n=t.features[0];if(!n||n.geometry.type!=="LineString")throw new Error("Route invalide");const a=n.geometry.coordinates,r=a.map(c=>c[1]),o=a.map(c=>c[0]),l=Math.min(...r),x=Math.max(...r),u=Math.min(...o),m=Math.max(...o),i=s/111;return(await de(async()=>{const c=`
        [out:json][timeout:8];
        (
          node["natural"="spring"](${l-i},${u-i},${x+i},${m+i});
          node["amenity"="drinking_water"](${l-i},${u-i},${x+i},${m+i});
        );
        out geom;
      `;return await O.post(oe,c,{headers:{"Content-Type":"text/plain"},timeout:1e4})},2,1e3)).data.elements.map(c=>({id:c.id.toString(),name:c.tags.name||bt(c.tags),type:yt(c.tags),lat:c.lat,lng:c.lon,elevation:c.tags.ele?parseInt(c.tags.ele):0,reliability:vt(c.tags),quality:jt(c.tags),notes:c.tags.description})).filter(c=>ce(c.lat,c.lng,a)<=s)}catch{return[]}},bt=t=>t.natural==="spring"?"Source":t.amenity==="drinking_water"?"Fontaine":t.man_made==="water_well"?"Puits":"Point d'eau",yt=t=>t.natural==="spring"?"source":t.amenity==="drinking_water"?"fontaine":t.waterway?"rivière":"lac",vt=t=>t.amenity==="drinking_water"||t.natural==="spring"?"permanent":"seasonal",jt=t=>t.amenity==="drinking_water"||t.drinking_water==="yes"?"potable":(t.natural==="spring","treatable"),Nt=(t,s,n=[],a=[])=>`<?xml version="1.0" encoding="UTF-8"?>
<gpx version="1.1" creator="WayMaker" xmlns="http://www.topografix.com/GPX/1/1">
  <metadata>
    <name>${t.name}</name>
    <desc>Itinéraire généré par WayMaker</desc>
    <time>${new Date().toISOString()}</time>
  </metadata>

  ${wt(t,s)}
  ${s.includeWaypoints?kt(t):""}
  ${s.includeRefuges?$t(n):""}
  ${s.includeWaterPoints?St(a):""}
</gpx>`,wt=(t,s)=>s.splitByStages?t.stages.map(n=>`
  <trk>
    <name>${n.name}</name>
    <desc>Distance: ${n.distance}km, Dénivelé: +${n.ascent}m/-${n.descent}m</desc>
    <trkseg>
      ${te(n.geojson,s.includeElevation)}
    </trkseg>
  </trk>`).join(""):`
  <trk>
    <name>${t.name}</name>
    <desc>Distance totale: ${t.totalDistance}km, Dénivelé: +${t.totalAscent}m/-${t.totalDescent}m</desc>
    <trkseg>
      ${te(t.geojson,s.includeElevation)}
    </trkseg>
  </trk>`,te=(t,s)=>{const n=t.features[0];if(!n||n.geometry.type!=="LineString")return"";const a=n.geometry.coordinates;return a?a.map(([r,o])=>`      <trkpt lat="${o}" lon="${r}">
        ${s?"<ele>0</ele>":""}
      </trkpt>`).join(`
`):""},kt=t=>{const s=[],n=t.stages[0].startPoint;s.push(`  <wpt lat="${n.lat}" lon="${n.lng}">
    <name>Départ</name>
    <sym>Flag, Green</sym>
  </wpt>`),t.stages.forEach((r,o)=>{o<t.stages.length-1&&s.push(`  <wpt lat="${r.endPoint.lat}" lon="${r.endPoint.lng}">
        <name>Fin étape ${o+1}</name>
        <sym>Waypoint</sym>
      </wpt>`)});const a=t.stages[t.stages.length-1].endPoint;return s.push(`  <wpt lat="${a.lat}" lon="${a.lng}">
    <name>Arrivée</name>
    <sym>Flag, Red</sym>
  </wpt>`),s.join(`
`)},$t=t=>t.map(s=>`  <wpt lat="${s.lat}" lon="${s.lng}">
    <name>${s.name}</name>
    <desc>Type: ${s.type}${s.elevation?`, Altitude: ${s.elevation}m`:""}</desc>
    <sym>Lodge</sym>
  </wpt>`).join(`
`),St=t=>t.map(s=>`  <wpt lat="${s.lat}" lon="${s.lng}">
    <name>${s.name}</name>
    <desc>Type: ${s.type}, Qualité: ${s.quality}</desc>
    <sym>Water Source</sym>
  </wpt>`).join(`
`);function Mt({route:t,refuges:s=[],waterPoints:n=[],onExport:a}){const[r,o]=g.useState(!1),[l,x]=g.useState({includeWaypoints:!0,includeRefuges:!0,includeWaterPoints:!0,splitByStages:!1,includeElevation:!0}),u=()=>{if(t)try{const i=Nt(t,l,s,n),f=`${t.name.toLowerCase().replace(/\s+/g,"_")}_${new Date().toISOString().split("T")[0]}.gpx`;if(a)a(i,f);else{const h=new Blob([i],{type:"application/gpx+xml"}),c=URL.createObjectURL(h),v=document.createElement("a");v.href=c,v.download=f,document.body.appendChild(v),v.click(),document.body.removeChild(v),URL.revokeObjectURL(c)}}catch{alert("Erreur lors de l'export GPX. Veuillez réessayer.")}},m=(i,f)=>{x(h=>({...h,[i]:f}))};return t?e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("h3",{className:"text-sm font-semibold text-gray-700",children:[e.jsx(K,{className:"inline mr-2"}),"Export GPX"]}),e.jsx("button",{onClick:()=>o(!r),className:"p-2 text-gray-600 hover:bg-gray-100 rounded-lg transition-colors",children:e.jsx(se,{className:"w-4 h-4"})})]}),r&&e.jsxs("div",{className:"space-y-3 p-3 bg-gray-50 rounded-lg border border-gray-200",children:[e.jsx("h4",{className:"text-xs font-medium text-gray-700 uppercase tracking-wide",children:"Options d'export"}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("label",{className:"flex items-center gap-2 text-sm",children:[e.jsx("input",{type:"checkbox",checked:l.includeWaypoints,onChange:i=>m("includeWaypoints",i.target.checked),className:"rounded border-gray-300 text-blue-600 focus:ring-blue-500"}),e.jsx("span",{children:"Points de passage"})]}),e.jsxs("label",{className:"flex items-center gap-2 text-sm",children:[e.jsx("input",{type:"checkbox",checked:l.includeRefuges,onChange:i=>m("includeRefuges",i.target.checked),className:"rounded border-gray-300 text-blue-600 focus:ring-blue-500"}),e.jsxs("span",{children:["Refuges (",s.length,")"]})]}),e.jsxs("label",{className:"flex items-center gap-2 text-sm",children:[e.jsx("input",{type:"checkbox",checked:l.includeWaterPoints,onChange:i=>m("includeWaterPoints",i.target.checked),className:"rounded border-gray-300 text-blue-600 focus:ring-blue-500"}),e.jsxs("span",{children:["Points d'eau (",n.length,")"]})]}),e.jsxs("label",{className:"flex items-center gap-2 text-sm",children:[e.jsx("input",{type:"checkbox",checked:l.splitByStages,onChange:i=>m("splitByStages",i.target.checked),className:"rounded border-gray-300 text-blue-600 focus:ring-blue-500"}),e.jsx("span",{children:"Séparer par étapes"})]}),e.jsxs("label",{className:"flex items-center gap-2 text-sm",children:[e.jsx("input",{type:"checkbox",checked:l.includeElevation,onChange:i=>m("includeElevation",i.target.checked),className:"rounded border-gray-300 text-blue-600 focus:ring-blue-500"}),e.jsx("span",{children:"Données d'altitude"})]})]})]}),e.jsx("div",{className:"p-3 bg-blue-50 border border-blue-200 rounded-lg",children:e.jsxs("div",{className:"text-sm text-blue-800",children:[e.jsx("div",{className:"font-medium mb-1",children:t.name}),e.jsxs("div",{className:"text-xs space-y-1",children:[e.jsxs("div",{children:["📏 ",t.totalDistance.toFixed(1)," km"]}),e.jsxs("div",{children:["📈 +",t.totalAscent,"m / -",t.totalDescent,"m"]}),e.jsxs("div",{children:["🏔️ ",t.minElevation,"m → ",t.maxElevation,"m"]}),e.jsxs("div",{children:["📍 ",t.stages.length," étape",t.stages.length>1?"s":""]}),l.includeRefuges&&s.length>0&&e.jsxs("div",{children:["🏠 ",s.length," refuge",s.length>1?"s":""]}),l.includeWaterPoints&&n.length>0&&e.jsxs("div",{children:["💧 ",n.length," point",n.length>1?"s":""," ","d'eau"]})]})]})}),e.jsxs("button",{onClick:u,className:"w-full flex items-center justify-center gap-2 px-4 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors font-medium",children:[e.jsx(Ne,{className:"w-4 h-4"}),"Télécharger GPX"]}),e.jsx("div",{className:"text-xs text-gray-500 bg-yellow-50 border border-yellow-200 p-2 rounded",children:"💡 Le fichier GPX peut être importé dans des applications comme Garmin Connect, Strava, ou des GPS de randonnée."})]}):e.jsx("div",{className:"p-4 bg-gray-50 rounded-lg border border-gray-200",children:e.jsxs("div",{className:"flex items-center gap-2 text-gray-500",children:[e.jsx(K,{className:"w-4 h-4"}),e.jsx("span",{className:"text-sm",children:"Créez un itinéraire pour exporter en GPX"})]})})}async function Pt(t){return new Promise((s,n)=>{const a=new FileReader;a.onload=r=>{try{const o=r.target?.result,l=Rt(o);s(l)}catch(o){n(new Error(`Erreur lors du parsing du fichier GPX: ${o instanceof Error?o.message:"Erreur inconnue"}`))}},a.onerror=()=>{n(new Error("Erreur lors de la lecture du fichier"))},a.readAsText(t)})}function Rt(t){const n=new DOMParser().parseFromString(t,"application/xml");if(n.querySelector("parsererror"))throw new Error("Format GPX invalide");const a=n.documentElement;if(a.tagName!=="gpx")throw new Error("Ce fichier n'est pas un fichier GPX valide");const r={tracks:[],waypoints:[],routes:[],metadata:Et(a)},o=a.querySelectorAll("wpt");r.waypoints=Array.from(o).map((u,m)=>Z(u,`waypoint-${m}`));const l=a.querySelectorAll("trk");r.tracks=Array.from(l).map((u,m)=>Dt(u,`track-${m}`));const x=a.querySelectorAll("rte");return r.routes=Array.from(x).map((u,m)=>It(u,`route-${m}`)),r}function Ct(t){const s=[];if(t.routes.length>0)return t.routes[0].waypoints;if(t.tracks.length>0){const n=t.tracks[0];return At(n.waypoints)}else if(t.waypoints.length>0)return t.waypoints;return s}function Et(t){const s=t.querySelector("metadata");if(s)return{name:s.querySelector("name")?.textContent||void 0,description:s.querySelector("desc")?.textContent||void 0,author:s.querySelector("author name")?.textContent||void 0,time:s.querySelector("time")?.textContent?new Date(s.querySelector("time").textContent):void 0}}function Z(t,s){const n=parseFloat(t.getAttribute("lat")||"0"),a=parseFloat(t.getAttribute("lon")||"0"),r=t.querySelector("name")?.textContent||`Point ${s}`;return{id:`gpx-${s}-${Date.now()}`,lat:n,lng:a,name:r}}function Dt(t,s){const n=t.querySelector("name")?.textContent||`Track ${s}`,a=t.querySelector("desc")?.textContent,r=[],o=t.querySelectorAll("trkseg");return Array.from(o).forEach((l,x)=>{const u=l.querySelectorAll("trkpt");Array.from(u).forEach((m,i)=>{r.push(Z(m,`${s}-seg${x}-pt${i}`))})}),{name:n,description:a,waypoints:r,bounds:me(r)}}function It(t,s){const n=t.querySelector("name")?.textContent||`Route ${s}`,a=t.querySelector("desc")?.textContent,r=t.querySelectorAll("rtept"),o=Array.from(r).map((l,x)=>Z(l,`${s}-pt${x}`));return{name:n,description:a,waypoints:o,bounds:me(o)}}function me(t){if(t.length===0)return;let s=t[0].lat,n=t[0].lat,a=t[0].lng,r=t[0].lng;return t.forEach(o=>{s=Math.min(s,o.lat),n=Math.max(n,o.lat),a=Math.min(a,o.lng),r=Math.max(r,o.lng)}),{minLat:s,maxLat:n,minLng:a,maxLng:r}}function At(t,s=20){if(t.length<=s)return t;const n=[],a=Math.floor(t.length/s);n.push(t[0]);for(let r=a;r<t.length-a;r+=a)n.push({...t[r],id:`simplified-${n.length}-${Date.now()}`});return t.length>1&&n.push(t[t.length-1]),n}function Tt(t,s,n,a){const o=(n-t)*Math.PI/180,l=(a-s)*Math.PI/180,x=Math.sin(o/2)*Math.sin(o/2)+Math.cos(t*Math.PI/180)*Math.cos(n*Math.PI/180)*Math.sin(l/2)*Math.sin(l/2);return 6371*(2*Math.atan2(Math.sqrt(x),Math.sqrt(1-x)))}function Lt(t){if(t.length<2)return 0;let s=0;for(let n=1;n<t.length;n++)s+=Tt(t[n-1].lat,t[n-1].lng,t[n].lat,t[n].lng);return s}function Ft({onGPXImported:t,onError:s,className:n=""}){const a=g.useRef(null),[r,o]=g.useState(!1),[l,x]=g.useState(!1),[u,m]=g.useState("idle"),[i,f]=g.useState(""),h=async b=>{if(!b.name.toLowerCase().endsWith(".gpx")){const j="Veuillez sélectionner un fichier GPX (.gpx)";m("error"),f(j),s?.(j);return}o(!0),m("idle"),f("");try{const j=await Pt(b),w=Ct(j);if(w.length===0)throw new Error("Aucun point de cheminement trouvé dans le fichier GPX");const d=Lt(w),E=`✅ ${j.metadata?.name||j.tracks[0]?.name||j.routes[0]?.name||"Itinéraire importé"} importé: ${w.length} points, ${d.toFixed(1)}km`;m("success"),f(E),t(w,j.metadata)}catch(j){const w=j instanceof Error?j.message:"Erreur lors de l'import du fichier GPX";m("error"),f(w),s?.(w)}finally{o(!1),a.current&&(a.current.value="")}},c=b=>{const j=b.target.files?.[0];j&&h(j)},v=b=>{b.preventDefault(),x(!0)},k=b=>{b.preventDefault(),x(!1)},N=b=>{b.preventDefault(),x(!1);const j=b.dataTransfer.files[0];j&&h(j)},M=()=>{a.current?.click()},C=()=>{switch(u){case"success":return e.jsx(fe,{className:"w-5 h-5 text-green-600"});case"error":return e.jsx(pe,{className:"w-5 h-5 text-red-600"});default:return e.jsx(ae,{className:"w-5 h-5 text-emerald-600"})}},p=()=>{switch(u){case"success":return"border-green-300 bg-green-50";case"error":return"border-red-300 bg-red-50";default:return l?"border-emerald-400 bg-emerald-50":"border-gray-300 bg-white"}};return e.jsxs("div",{className:n,children:[e.jsxs("div",{onDragOver:v,onDragLeave:k,onDrop:N,onClick:M,className:`relative border-2 border-dashed rounded-2xl p-6 transition-all duration-200 cursor-pointer hover:border-emerald-400 hover:bg-emerald-50/50 ${p()}`,children:[e.jsx("input",{ref:a,type:"file",accept:".gpx",onChange:c,className:"hidden"}),e.jsxs("div",{className:"flex flex-col items-center gap-3 text-center",children:[r?e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-emerald-600"}):C(),e.jsxs("div",{children:[e.jsx("h3",{className:"text-sm font-medium text-gray-900 mb-1",children:r?"Traitement du fichier...":"Importer un fichier GPX"}),e.jsx("p",{className:"text-xs text-gray-500",children:"Glissez-déposez un fichier .gpx ou cliquez pour parcourir"})]}),e.jsxs("div",{className:"flex items-center gap-2 text-xs text-gray-400",children:[e.jsx(Ye,{className:"w-4 h-4"}),e.jsx("span",{children:"Formats: .gpx"})]})]})]}),i&&e.jsx("div",{className:`mt-3 p-3 rounded-xl text-sm ${u==="success"?"bg-green-50 text-green-800 border border-green-200":"bg-red-50 text-red-800 border border-red-200"}`,children:i}),e.jsxs("div",{className:"mt-4 text-xs text-gray-500 space-y-1",children:[e.jsxs("p",{children:[e.jsx("strong",{children:"💡 Astuce:"})," Les fichiers GPX peuvent contenir des tracks, routes ou waypoints."]}),e.jsxs("p",{children:[e.jsx("strong",{children:"📍 Priorité:"})," Routes → Tracks → Waypoints individuels"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"⚡ Performance:"})," Les tracks longs sont automatiquement simplifiés (max 20 points)"]})]})]})}const ue=g.forwardRef((t,s)=>{const{route:n,refuges:a=[],waterPoints:r=[],showRefuges:o=!1,showWaterPoints:l=!1,onToggleRefuges:x,onToggleWaterPoints:u,className:m="",onMapClick:i,waypoints:f=[]}=t,h=g.useRef(null),c=g.useRef(null),v=g.useRef([]),k=g.useRef([]),N=g.useRef([]),M=g.useRef([]),[C,p]=g.useState("osmFrance"),[b,j]=g.useState(!1);g.useEffect(()=>{if(document.getElementById("hiking-map")&&!h.current){const E=De("hiking-map",[45,2],6,"osmFrance");E.doubleClickZoom.disable(),h.current=E}return()=>{h.current&&(h.current.remove(),h.current=null)}},[]),g.useEffect(()=>{if(h.current&&i){const d=h.current,S=E=>{const{lat:I,lng:A}=E.latlng;i(I,A)};return d.on("dblclick",S),()=>{d.off("dblclick",S)}}},[i]),g.useEffect(()=>{if(h.current&&(c.current&&(h.current.removeLayer(c.current),c.current=null),v.current.forEach(d=>{h.current.removeLayer(d)}),v.current=[],!!n))try{const d=L.geoJSON(n.geojson,{style:{color:"#e11d48",weight:4,opacity:.8,lineCap:"round",lineJoin:"round"}});d.addTo(h.current),c.current=d,h.current.fitBounds(d.getBounds(),{padding:[20,20]}),n.stages.forEach((A,F)=>{const y=L.divIcon({className:"stage-marker",html:`
            <div class="bg-green-500 text-white rounded-full w-8 h-8 flex items-center justify-center text-sm font-bold shadow-lg">
              ${F+1}
            </div>
          `,iconSize:[32,32],iconAnchor:[16,16]}),T=L.marker([A.startPoint.lat,A.startPoint.lng],{icon:y}).addTo(h.current).bindPopup(`
            <div class="text-center">
              <strong>${A.name}</strong><br>
              <small>Distance: ${A.distance}km</small><br>
              <small>Dénivelé: +${A.ascent}m/-${A.descent}m</small>
            </div>
          `);v.current.push(T)});const S=n.stages[n.stages.length-1],E=L.divIcon({className:"finish-marker",html:`
          <div class="bg-red-500 text-white rounded-full w-8 h-8 flex items-center justify-center text-sm font-bold shadow-lg">
            🏁
          </div>
        `,iconSize:[32,32],iconAnchor:[16,16]}),I=L.marker([S.endPoint.lat,S.endPoint.lng],{icon:E}).addTo(h.current).bindPopup(`
          <div class="text-center">
            <strong>Arrivée</strong><br>
            <small>Distance totale: ${n.totalDistance}km</small><br>
            <small>Dénivelé total: +${n.totalAscent}m/-${n.totalDescent}m</small>
          </div>
        `);v.current.push(I)}catch{}},[n]),g.useEffect(()=>{h.current&&(k.current.forEach(d=>{h.current.removeLayer(d)}),k.current=[],o&&a.length>0&&a.forEach(d=>{const S=L.divIcon({className:"refuge-marker",html:`
            <div class="bg-blue-600 text-white rounded-lg px-2 py-1 text-xs font-medium shadow-lg">
              🏠 ${d.name}
            </div>
          `,iconSize:[100,24],iconAnchor:[50,12]}),E=L.marker([d.lat,d.lng],{icon:S}).addTo(h.current).bindPopup(`
            <div>
              <strong>${d.name}</strong><br>
              <small>Type: ${d.type}</small><br>
              ${d.elevation?`<small>Altitude: ${d.elevation}m</small><br>`:""}
              ${d.capacity?`<small>Capacité: ${d.capacity} places</small><br>`:""}
              ${d.contact?`<small>Contact: ${d.contact}</small>`:""}
            </div>
          `);k.current.push(E)}))},[o,a]),g.useEffect(()=>{h.current&&(N.current.forEach(d=>{h.current.removeLayer(d)}),N.current=[],l&&r.length>0&&r.forEach(d=>{const S=L.divIcon({className:"water-marker",html:`
            <div class="bg-cyan-500 text-white rounded-lg px-2 py-1 text-xs font-medium shadow-lg">
              💧 ${d.name}
            </div>
          `,iconSize:[100,24],iconAnchor:[50,12]}),E=L.marker([d.lat,d.lng],{icon:S}).addTo(h.current).bindPopup(`
            <div>
              <strong>${d.name}</strong><br>
              <small>Type: ${d.type}</small><br>
              <small>Qualité: ${d.quality}</small><br>
              <small>Fiabilité: ${d.reliability}</small><br>
              ${d.elevation?`<small>Altitude: ${d.elevation}m</small>`:""}
              ${d.notes?`<br><small>${d.notes}</small>`:""}
            </div>
          `);N.current.push(E)}))},[l,r]),g.useEffect(()=>{h.current&&(M.current.forEach(d=>{h.current.removeLayer(d)}),M.current=[],!(!f||f.length===0)&&f.forEach((d,S)=>{if(d.lat===0&&d.lng===0)return;const E=S===0,I=S===f.length-1&&f.length>1;let A="",F="";E?(A=`
          <div class="bg-green-600 text-white rounded-full w-10 h-10 flex items-center justify-center text-sm font-bold shadow-lg border-2 border-white">
            A
          </div>
        `,F="start-marker"):I?(A=`
          <div class="bg-red-600 text-white rounded-full w-10 h-10 flex items-center justify-center text-sm font-bold shadow-lg border-2 border-white">
            B
          </div>
        `,F="end-marker"):(A=`
          <div class="bg-blue-600 text-white rounded-full w-8 h-8 flex items-center justify-center text-xs font-bold shadow-lg border-2 border-white">
            ${S}
          </div>
        `,F="intermediate-marker");const y=L.divIcon({className:`waypoint-marker ${F}`,html:A,iconSize:E||I?[40,40]:[32,32],iconAnchor:E||I?[20,20]:[16,16]}),T=E?"Départ":I?"Arrivée":`Étape ${S}`,R=L.marker([d.lat,d.lng],{icon:y}).addTo(h.current).bindPopup(`
          <div class="text-center">
            <strong>${T}</strong><br>
            <small>${d.name||`Point ${S+1}`}</small><br>
            <small>Lat: ${d.lat.toFixed(6)}</small><br>
            <small>Lng: ${d.lng.toFixed(6)}</small>
          </div>
        `);M.current.push(R)}))},[f]),g.useImperativeHandle(s,()=>({clearWaypoints:()=>{h.current&&(M.current.forEach(d=>{h.current.removeLayer(d)}),M.current=[],v.current.forEach(d=>{h.current.removeLayer(d)}),v.current=[])},zoomToPOI:(d,S,E=15)=>{if(h.current)try{h.current.setView([d,S],E,{animate:!0,duration:1});const I=L.divIcon({className:"poi-highlight-marker",html:`
            <div style="
              width: 24px; 
              height: 24px; 
              background-color: #ef4444; 
              border-radius: 50%; 
              border: 3px solid white;
              box-shadow: 0 0 0 2px #ef4444;
              animation: pulse 1s infinite;
            "></div>
          `,iconSize:[24,24],iconAnchor:[12,12]}),A=L.marker([d,S],{icon:I}).addTo(h.current);setTimeout(()=>{h.current&&A&&h.current.removeLayer(A)},3e3)}catch{}}}),[]);const w=d=>{h.current&&(Ae(h.current,d),p(d))};return e.jsxs("div",{className:`relative bg-white rounded-lg shadow-sm ${m}`,children:[e.jsxs("div",{className:"absolute top-4 left-4 z-[9999]",style:{zIndex:9999},children:[e.jsxs("button",{onClick:()=>j(!b),className:`
            relative bg-white hover:bg-blue-50 border-2 rounded-xl p-3 shadow-xl
            transition-all duration-200 group
            ${b?"border-blue-500 bg-blue-50":"border-gray-300 hover:border-blue-400"}
          `,title:"🗺️ Sélectionner les cartes de randonnée",style:{zIndex:9999,position:"relative"},children:[e.jsx("div",{className:"absolute -top-1 -right-1 w-3 h-3 bg-green-500 rounded-full animate-pulse"}),e.jsx("div",{className:`absolute -bottom-10 left-1/2 transform -translate-x-1/2
                         bg-gray-900 text-white text-xs px-3 py-2 rounded-lg
                         opacity-0 group-hover:opacity-100 transition-opacity duration-200
                         whitespace-nowrap z-50 pointer-events-none`,children:"🗺️ OSM France • OpenTopoMap • CyclOSM"}),e.jsx("svg",{className:`w-6 h-6 transition-colors ${b?"text-blue-600":"text-gray-600 group-hover:text-blue-600"}`,fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"})})]}),b&&e.jsx("div",{className:"absolute top-16 left-0 min-w-[280px] z-[9999]",style:{zIndex:9999},children:e.jsx(Ie,{map:h.current,currentLayer:C,onLayerChange:w})})]}),e.jsx("div",{className:"absolute bottom-4 left-4 z-[9998] bg-white bg-opacity-95 rounded-lg p-3 text-sm shadow-lg border border-gray-200",style:{zIndex:9998},children:e.jsxs("div",{className:"flex items-center space-x-4 flex-wrap",children:[f.length>0&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center space-x-1",children:[e.jsx("div",{className:"w-5 h-5 bg-green-600 rounded-full text-white text-xs flex items-center justify-center font-bold",children:"A"}),e.jsx("span",{children:"Départ"})]}),f.length>2&&e.jsxs("div",{className:"flex items-center space-x-1",children:[e.jsx("div",{className:"w-4 h-4 bg-blue-600 rounded-full text-white text-xs flex items-center justify-center font-bold",children:"•"}),e.jsx("span",{children:"Étapes"})]}),f.length>1&&e.jsxs("div",{className:"flex items-center space-x-1",children:[e.jsx("div",{className:"w-5 h-5 bg-red-600 rounded-full text-white text-xs flex items-center justify-center font-bold",children:"B"}),e.jsx("span",{children:"Arrivée"})]})]}),n&&e.jsxs("div",{className:"flex items-center space-x-1",children:[e.jsx("div",{className:"w-4 h-1 bg-pink-600 rounded"}),e.jsx("span",{children:"Itinéraire"})]}),a.length>0&&e.jsxs("button",{onClick:()=>x?.(!o),className:`flex items-center space-x-1 px-2 py-1 rounded transition-colors ${o?"bg-green-100 hover:bg-green-200":"bg-gray-100 hover:bg-gray-200 opacity-60"}`,title:o?"Masquer les refuges":"Afficher les refuges",children:[e.jsx("span",{children:"🏠"}),e.jsx("span",{className:o?"text-green-800":"text-gray-600",children:"Refuges"})]}),r.length>0&&e.jsxs("button",{onClick:()=>u?.(!l),className:`flex items-center space-x-1 px-2 py-1 rounded transition-colors ${l?"bg-blue-100 hover:bg-blue-200":"bg-gray-100 hover:bg-gray-200 opacity-60"}`,title:l?"Masquer les points d'eau":"Afficher les points d'eau",children:[e.jsx("span",{children:"💧"}),e.jsx("span",{className:l?"text-blue-800":"text-gray-600",children:"Points d'eau"})]})]})}),e.jsx("div",{id:"hiking-map",className:"h-[calc(100vh-16rem)] w-full"})]})});ue.displayName="HikingMap";const B=g.memo(({title:t,icon:s,count:n,isVisible:a,onToggle:r,children:o,accentColor:l="green"})=>{const x={green:{visible:"bg-green-100 text-green-700 hover:bg-green-200",hidden:"bg-gray-100 text-gray-600 hover:bg-gray-200"},blue:{visible:"bg-blue-100 text-blue-700 hover:bg-blue-200",hidden:"bg-gray-100 text-gray-600 hover:bg-gray-200"},gray:{visible:"bg-gray-100 text-gray-700 hover:bg-gray-200",hidden:"bg-gray-100 text-gray-600 hover:bg-gray-200"}},u=a?x[l].visible:x[l].hidden;return e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[s,e.jsxs("span",{className:"text-sm font-medium",children:[t," (",n,")"]})]}),e.jsx("button",{onClick:r,className:`p-2 rounded-lg transition-colors ${u}`,children:a?e.jsx(we,{className:"w-3 h-3"}):e.jsx(ke,{className:"w-3 h-3"})})]}),a&&o]})});B.displayName="ToggleSection";const U=g.memo(({value:t,onChange:s,options:n,placeholder:a="Tous les types"})=>e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx($e,{className:"w-3 h-3 text-gray-500"}),e.jsxs("select",{value:t,onChange:r=>s(r.target.value),className:"flex-1 px-2 py-1 text-xs border border-gray-300 rounded focus:outline-none focus:border-blue-500",children:[e.jsx("option",{value:"all",children:a}),n.map(r=>e.jsx("option",{value:r.value,children:r.label},r.value))]})]}));U.displayName="FilterSelect";const H=g.memo(({children:t,maxHeight:s="max-h-32",emptyMessage:n="Aucun élément trouvé",isEmpty:a=!1})=>a?e.jsx("div",{className:"text-xs text-gray-500 italic",children:n}):e.jsx("div",{className:`${s} overflow-y-auto scroll-smooth scrollbar-thin scrollbar-thumb-gray-400 scrollbar-track-gray-100 hover:scrollbar-thumb-gray-500 space-y-1 pr-1`,style:{scrollbarWidth:"thin",scrollbarColor:"#9CA3AF #F3F4F6"},children:t}));H.displayName="ScrollableList";const V=g.memo(({name:t,typeIcon:s,typeName:n,elevation:a,onClick:r,children:o})=>e.jsx("button",{onClick:r,className:"w-full text-left p-3 hover:bg-blue-50 hover:border-blue-300 hover:shadow-sm rounded-lg border border-gray-200 transition-all duration-200 cursor-pointer group transform hover:scale-[1.02] active:scale-[0.98]",title:`Cliquer pour zoomer sur ${t}`,children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("span",{className:"text-base flex-shrink-0 mt-0.5",children:s}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:"text-sm font-medium text-gray-800 truncate group-hover:text-blue-700 transition-colors",children:t}),e.jsxs("div",{className:"text-xs text-gray-500 mt-0.5",children:[n,a&&a>0&&` • ${a}m`]}),o]}),e.jsx("div",{className:"opacity-0 group-hover:opacity-100 transition-all duration-200 text-blue-500 transform group-hover:scale-110",children:"🔍"})]})}));V.displayName="POIItem";const he=g.memo(({title:t="Légende",items:s,columns:n=2})=>e.jsxs("div",{className:"p-3 bg-gray-50 rounded-lg",children:[e.jsx("div",{className:"text-xs font-medium text-gray-700 mb-2",children:t}),e.jsx("div",{className:"space-y-1 text-xs",children:e.jsx("div",{className:`grid grid-cols-${n} gap-2`,children:s.map((a,r)=>e.jsxs("div",{children:[a.icon," ",a.label]},r))})})]}));he.displayName="Legend";const Wt=[{value:"gardé",label:"Refuges gardés"},{value:"libre",label:"Refuges libres"},{value:"bivouac",label:"Bivouacs"}],Ot=[{value:"source",label:"Sources"},{value:"fontaine",label:"Fontaines"},{value:"rivière",label:"Rivières"},{value:"lac",label:"Lacs"}],_t=[{icon:"🏠",label:"Refuges"},{icon:"💧",label:"Points d'eau"}];function zt({refuges:t,waterPoints:s,showRefuges:n,showWaterPoints:a,onToggleRefuges:r,onToggleWaterPoints:o,onRefugeSelect:l,onWaterPointSelect:x}){const[u,m]=g.useState(""),[i,f]=g.useState(""),h=g.useMemo(()=>!u||u==="all"?t:t.filter(N=>N.type===u),[t,u]),c=g.useMemo(()=>!i||i==="all"?s:s.filter(N=>N.type===i),[s,i]),v=g.useCallback(N=>{l?.(N)},[l]),k=g.useCallback(N=>{x?.(N)},[x]);return e.jsxs("div",{className:"space-y-4",children:[e.jsx(B,{title:"Refuges",icon:e.jsx(Se,{}),count:h.length,isVisible:n,onToggle:()=>r(!n),accentColor:"green",children:e.jsxs("div",{className:"space-y-3",children:[e.jsx(U,{options:Wt,value:u,onChange:m,placeholder:"Filtrer par type"}),h.length>0?e.jsx(H,{maxHeight:"max-h-48 md:max-h-64",children:h.map(N=>e.jsx(V,{name:N.name,typeIcon:"🏠",typeName:N.type,elevation:N.elevation,onClick:()=>v(N)},N.id))}):e.jsx("div",{className:"text-gray-500 text-sm text-center py-4 bg-gray-50 rounded-lg border border-dashed border-gray-300",children:t.length===0?"🔍 Aucun refuge trouvé (possible timeout API)":"Aucun refuge ne correspond aux filtres"})]})}),e.jsx(B,{title:"Points d'eau",icon:e.jsx(Me,{}),count:c.length,isVisible:a,onToggle:()=>o(!a),accentColor:"blue",children:e.jsxs("div",{className:"space-y-3",children:[e.jsx(U,{options:Ot,value:i,onChange:f,placeholder:"Filtrer par type"}),c.length>0?e.jsx(H,{maxHeight:"max-h-48 md:max-h-64",children:c.map(N=>e.jsx(V,{name:N.name,typeIcon:"💧",typeName:N.type,onClick:()=>k(N)},N.id))}):e.jsx("div",{className:"text-gray-500 text-sm text-center py-4 bg-gray-50 rounded-lg border border-dashed border-gray-300",children:s.length===0?"🔍 Aucun point d'eau trouvé (possible timeout API)":"Aucun point d'eau ne correspond aux filtres"})]})}),e.jsx(he,{items:_t})]})}function xe({value:t,onChange:s,onLocationSelect:n,placeholder:a="Nom du point",className:r=""}){const[o,l]=g.useState([]),[x,u]=g.useState(!1),[m,i]=g.useState(!1),f=g.useRef(null),h=g.useRef(null),c=g.useCallback(async p=>{if(!p||p.length<3){l([]);return}i(!0);try{const b=await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(p)}&limit=5`);if(b.ok){const j=await b.json();l(j)}else l([])}catch{l([])}finally{i(!1)}},[]);g.useEffect(()=>{const p=setTimeout(()=>{x&&c(t)},300);return()=>clearTimeout(p)},[t,x,c]);const v=p=>{const b=p.target.value;s(b),u(!0)},k=p=>{const b=parseFloat(p.lat),j=parseFloat(p.lon),w=p.display_name;s(w),n(b,j,w),u(!1),l([])},N=()=>{t.length>=3&&u(!0)},M=()=>{setTimeout(()=>{u(!1)},150)},C=p=>{p.key==="Escape"&&u(!1)};return e.jsxs("div",{className:"relative",children:[e.jsx("input",{ref:f,type:"text",value:t,onChange:v,onFocus:N,onBlur:M,onKeyDown:C,placeholder:a,className:`${r} w-full`}),x&&(o.length>0||m)&&e.jsxs("div",{ref:h,className:"absolute top-full left-0 right-0 z-50 bg-white border border-gray-200 rounded-md shadow-lg max-h-48 overflow-y-auto",children:[m&&e.jsx("div",{className:"px-3 py-2 text-xs text-gray-500",children:"Recherche en cours..."}),!m&&o.length>0&&e.jsx("ul",{children:o.map((p,b)=>e.jsxs("li",{onClick:()=>k(p),className:"px-3 py-2 text-xs hover:bg-blue-50 cursor-pointer border-b border-gray-100 last:border-b-0",children:[e.jsx("div",{className:"font-medium text-gray-800 truncate",children:p.display_name}),e.jsxs("div",{className:"text-gray-500 text-[10px] mt-1",children:[parseFloat(p.lat).toFixed(4),", ",parseFloat(p.lon).toFixed(4)]})]},`${p.place_id||b}-${p.display_name}`))})]})]})}function qt({waypoint:t,index:s,isFirst:n,isLast:a,isLoop:r,onUpdate:o,onRemove:l,canRemove:x,onLocationSelect:u}){const{attributes:m,listeners:i,setNodeRef:f,transform:h,transition:c,isDragging:v}=We({id:t.id||`waypoint-${s}`}),k={transform:Oe.Transform.toString(h),transition:c},N=()=>n?"A":a&&!r?"B":(s+1).toString(),M=()=>n?"bg-green-500":a&&!r?"bg-red-500":"bg-blue-500";return e.jsxs("div",{ref:f,style:k,className:`
        flex items-center gap-2 p-2 bg-gray-50 rounded-lg border transition-all
        ${v?"shadow-lg bg-white border-blue-300 scale-105":"border-transparent"}
      `,children:[e.jsx("div",{...m,...i,className:"flex-shrink-0 p-1 cursor-grab hover:bg-gray-200 rounded transition-colors",children:e.jsx(Pe,{className:"w-3 h-3 text-gray-400"})}),e.jsx("div",{className:`
          flex-shrink-0 w-6 h-6 text-white text-xs rounded-full 
          flex items-center justify-center font-bold
          ${M()}
        `,children:N()}),e.jsx("div",{className:"flex-1",children:e.jsx(xe,{value:t.name||"",onChange:C=>o("name",C),onLocationSelect:(C,p,b)=>{o("lat",C),o("lng",p),o("name",b),u?.(C,p,b)},placeholder:`Point ${s+1}`,className:"px-2 py-1 text-xs border border-gray-300 rounded focus:outline-none focus:border-blue-500"})}),t.lat!==0&&t.lng!==0&&e.jsxs("div",{className:"flex-shrink-0 text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded",children:[t.lat.toFixed(4),", ",t.lng.toFixed(4)]}),e.jsx("button",{onClick:l,disabled:!x,className:"flex-shrink-0 p-1 text-red-600 hover:bg-red-50 rounded disabled:opacity-50 disabled:cursor-not-allowed transition-colors",children:e.jsx(ne,{className:"w-3 h-3"})})]})}const ge=[{id:"gr-official",name:"Sentiers officiels",description:"GR, GRP, PR, HRP uniquement",color:"#dc2626",icon:Re,preferences:{preferOfficial:!0,allowUnofficial:!1,noPreference:!1}},{id:"mixed-paths",name:"Chemins mixtes",description:"Officiels et non-officiels",color:"#ea580c",icon:re,preferences:{preferOfficial:!0,allowUnofficial:!0,noPreference:!1}},{id:"mountain-paths",name:"Sentiers montagne",description:"Tous types de sentiers",color:"#7c3aed",icon:X,preferences:{preferOfficial:!1,allowUnofficial:!0,noPreference:!0}},{id:"no-preference",name:"Sans préférence",description:"Tous types de chemins",color:"#16a34a",icon:Ce,preferences:{preferOfficial:!1,allowUnofficial:!0,noPreference:!0}}];function Gt({waypoints:t,onWaypointsChange:s,isLoop:n,onLoopChange:a,stageCount:r,onStageCountChange:o,hikingProfile:l,onProfileChange:x,maxStages:u=10}){const[m,i]=g.useState(""),f=_e(Y(Ve),Y(He,{coordinateGetter:Ue})),h=p=>{const{active:b,over:j}=p;if(b.id!==j?.id){const w=t.findIndex(S=>S.id===b.id),d=t.findIndex(S=>S.id===j?.id);if(w!==-1&&d!==-1){const S=Be(t,w,d);s(S)}}},c=()=>{if(t.length>=20)return;const p={id:`waypoint-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,lat:0,lng:0,name:m||`Point ${t.length+1}`};s([...t,p]),i("")},v=(p,b,j)=>{if(t.length>=20)return;const w={id:`waypoint-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,lat:p,lng:b,name:j};s([...t,w]),i("")},k=p=>{if(t.length<=2)return;const b=t.filter((j,w)=>w!==p);s(b)},N=(p,b,j)=>{const w=[...t];w[p]={...w[p],[b]:j},s(w)},M=(p,b,j,w)=>{const d=[...t];d[p]={...d[p],lat:b,lng:j,name:w},s(d)},C=()=>{if(t.length<2)return"Ajoutez au moins 2 points pour créer un itinéraire";const p=n?t.length+1:t.length,b=Math.ceil(p/r);return`${r} étape${r>1?"s":""} • ~${b} point${b>1?"s":""} par étape`};return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("h3",{className:"text-sm font-semibold text-gray-700",children:[e.jsx(re,{className:"inline mr-2"}),"Planification d'itinéraire"]}),e.jsxs("button",{onClick:()=>a(!n),className:`
            flex items-center gap-2 px-3 py-1 rounded-lg text-xs font-medium transition-all
            ${n?"bg-green-100 text-green-700 border border-green-300":"bg-gray-100 text-gray-600 border border-gray-300 hover:bg-gray-200"}
          `,children:[e.jsx(Ee,{className:"w-3 h-3"}),n?"Boucle":"Linéaire"]})]}),e.jsxs("div",{className:`p-3 rounded-lg border ${n?"bg-green-50 border-green-200":"bg-blue-50 border-blue-200"}`,children:[e.jsx("div",{className:"text-sm font-medium",children:n?"Itinéraire en boucle":"Itinéraire linéaire"}),e.jsx("div",{className:"text-xs text-gray-600 mt-1",children:n?"Le point d'arrivée sera le même que le point de départ":"Itinéraire du point A au point B"})]}),x&&e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(se,{className:"w-4 h-4 text-gray-600"}),e.jsx("h4",{className:"text-sm font-semibold text-gray-700",children:"Préférences de sentiers"})]}),e.jsx("div",{className:"grid grid-cols-2 gap-2",children:ge.map(p=>{const b=p.icon,j=l?.id===p.id;return e.jsxs("button",{onClick:()=>x(p),className:`
                    flex items-center gap-2 p-2 rounded-lg border text-xs transition-all
                    ${j?"border-blue-500 bg-blue-50 text-blue-700":"border-gray-200 bg-white text-gray-600 hover:border-gray-300 hover:bg-gray-50"}
                  `,children:[e.jsx("div",{className:`
                      flex items-center justify-center w-6 h-6 rounded
                      ${j?"bg-blue-100":"bg-gray-100"}
                    `,children:e.jsx(b,{className:`w-3 h-3 ${j?"text-blue-600":"text-gray-600"}`})}),e.jsx("div",{className:"flex-1 text-left",children:e.jsx("div",{className:"font-medium",children:p.name})})]},p.id)})}),l&&e.jsxs("div",{className:"bg-gray-50 border border-gray-200 p-2 rounded text-xs",children:[e.jsx("div",{className:"font-medium text-gray-700 mb-1",children:l.name}),e.jsx("div",{className:"text-gray-600 mb-2",children:l.description}),e.jsxs("div",{className:"space-y-1 mb-2",children:[e.jsx("div",{className:"font-medium text-gray-700",children:"Effets sur le calcul d'itinéraire :"}),l.preferences.preferOfficial&&!l.preferences.allowUnofficial&&e.jsxs("div",{className:"flex items-start gap-1",children:[e.jsx("span",{className:"w-1 h-1 bg-green-500 rounded-full mt-1 flex-shrink-0"}),e.jsx("span",{children:"Évite les escaliers urbains et ferries, privilégie les sentiers de randonnée balisés"})]}),l.preferences.preferOfficial&&l.preferences.allowUnofficial&&e.jsxs("div",{className:"flex items-start gap-1",children:[e.jsx("span",{className:"w-1 h-1 bg-orange-500 rounded-full mt-1 flex-shrink-0"}),e.jsx("span",{children:"Équilibre entre sentiers officiels et alternatifs, évite seulement les ferries"})]}),l.preferences.noPreference&&e.jsxs("div",{className:"flex items-start gap-1",children:[e.jsx("span",{className:"w-1 h-1 bg-gray-500 rounded-full mt-1 flex-shrink-0"}),e.jsx("span",{children:"Optimise uniquement sur distance et dénivelé, autorise tous types de chemins"})]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("div",{className:"font-medium text-gray-700",children:"Types de sentiers :"}),l.preferences.preferOfficial&&e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("span",{className:"w-1 h-1 bg-green-500 rounded-full"}),e.jsx("span",{children:"Privilégie les sentiers officiels (GR, HRP, etc.)"})]}),l.preferences.allowUnofficial&&e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("span",{className:"w-1 h-1 bg-orange-500 rounded-full"}),e.jsx("span",{children:"Autorise les sentiers non-officiels"})]}),l.preferences.noPreference&&e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("span",{className:"w-1 h-1 bg-gray-500 rounded-full"}),e.jsx("span",{children:"Aucune préférence de type de sentier"})]})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("label",{className:"text-sm font-medium text-gray-700",children:["Nombre d'étapes : ",r]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:()=>o(Math.max(1,r-1)),disabled:r<=1,className:"p-2 rounded-lg border border-gray-300 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed",children:e.jsx(ne,{className:"w-3 h-3"})}),e.jsx("input",{type:"range",min:"1",max:u,value:r,onChange:p=>o(parseInt(p.target.value)),className:"flex-1"}),e.jsx("button",{onClick:()=>o(Math.min(u,r+1)),disabled:r>=u,className:"p-2 rounded-lg border border-gray-300 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed",children:e.jsx(G,{className:"w-3 h-3"})})]}),e.jsx("div",{className:"text-xs text-gray-600 bg-gray-50 p-2 rounded",children:C()})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("label",{className:"text-sm font-medium text-gray-700",children:["Points de passage (",t.length,")"]}),e.jsx("button",{onClick:c,disabled:t.length>=20,className:"p-1 rounded text-blue-600 hover:bg-blue-50 disabled:opacity-50 disabled:cursor-not-allowed",children:e.jsx(G,{className:"w-3 h-3"})})]}),e.jsx("div",{className:"space-y-2",children:e.jsx(ze,{sensors:f,collisionDetection:qe,onDragEnd:h,children:e.jsx(Ge,{items:t.map(p=>p.id||`waypoint-${t.indexOf(p)}`),strategy:Xe,children:t.map((p,b)=>e.jsx(qt,{waypoint:p,index:b,isFirst:b===0,isLast:b===t.length-1,isLoop:n,onUpdate:(j,w)=>N(b,j,w),onRemove:()=>k(b),canRemove:t.length>2,onLocationSelect:(j,w,d)=>M(b,j,w,d)},p.id||`waypoint-${b}`))})})}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("div",{className:"flex-1",children:e.jsx(xe,{value:m,onChange:i,onLocationSelect:v,placeholder:"Nom du nouveau point",className:"px-3 py-2 text-sm border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500"})}),e.jsx("button",{onClick:c,disabled:t.length>=20,className:"px-3 py-2 bg-blue-600 text-white text-sm rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed",children:e.jsx(G,{className:"w-4 h-4"})})]})]}),e.jsxs("div",{className:"text-xs text-gray-500 bg-yellow-50 border border-yellow-200 p-2 rounded space-y-1",children:[e.jsx("div",{children:"💡 Double-cliquez sur la carte pour définir les points de passage"}),e.jsx("div",{children:"🔄 Glissez-déposez les points dans la liste pour changer l'ordre"})]})]})}function Xt({onError:t,onSuccess:s}={}){const[n,a]=g.useState(ge[0]),[r,o]=g.useState([{id:`waypoint-${Date.now()}-init-a`,lat:0,lng:0,name:"Point A"},{id:`waypoint-${Date.now()}-init-b`,lat:0,lng:0,name:"Point B"}]),[l,x]=g.useState(!1),[u,m]=g.useState(1),[i,f]=g.useState(null),[h,c]=g.useState([]),[v,k]=g.useState([]),[N,M]=g.useState(!1),[C,p]=g.useState(!0),[b,j]=g.useState(!0),w=g.useCallback(R=>R.map(($,D)=>({...$,id:$.id||`waypoint-${Date.now()}-${D}-${Math.random().toString(36).substr(2,9)}`})),[]),d=g.useCallback(R=>{o(typeof R=="function"?$=>w(R($)):w(R))},[w]),S=g.useCallback(async R=>{try{const[$,D]=await Promise.allSettled([xt(R.geojson,2),ft(R.geojson,1)]);let P=!1;$.status==="fulfilled"?c($.value):(c([]),P=!0),D.status==="fulfilled"?k(D.value):(k([]),P=!0),P&&t?.("⚠️ Certains points d'intérêt n'ont pas pu être chargés (timeout API)")}catch{c([]),k([]),t?.("⚠️ Impossible de charger les points d'intérêt")}},[t]),E=g.useCallback(async()=>{if(r.length<2){t?.("Au moins 2 points sont nécessaires pour créer un itinéraire");return}if(r.filter($=>$.lat===0&&$.lng===0).length>0){t?.("Veuillez positionner tous les points sur la carte");return}M(!0);try{const $=await mt(r,l,1,n),D=u>1?ct($,u):$;f(D),s?.(D),await S(D)}catch($){let D="Erreur lors de la création de l'itinéraire";$ instanceof Error?D=$.message:typeof $=="string"?D=$:$&&typeof $=="object"&&"message"in $&&(D=String($.message)),t?.(D)}finally{M(!1)}},[r,l,u,n,t,s,S]),I=g.useCallback((R,$,D)=>{o(P=>{const W=[...P];return W[R]&&(W[R]={...W[R],lat:$,lng:D}),W})},[]),A=g.useCallback((R,$,D)=>{const P={lat:R,lng:$,name:D||`Point ${r.length+1}`};o(W=>[...W,P])},[r.length]),F=g.useCallback(R=>{r.length<=2||o($=>$.filter((D,P)=>P!==R))},[r.length]),y=g.useCallback(()=>{f(null),c([]),k([])},[]),T=g.useCallback(()=>{o([]),setTimeout(()=>{o([{id:`waypoint-reset-${Date.now()}-a`,lat:0,lng:0,name:"Point A"},{id:`waypoint-reset-${Date.now()}-b`,lat:0,lng:0,name:"Point B"}])},10),x(!1),m(1),y()},[y]);return{hikingProfile:n,setHikingProfile:a,waypoints:r,setWaypoints:d,isLoop:l,setIsLoop:x,stageCount:u,setStageCount:m,currentRoute:i,refuges:h,waterPoints:v,isLoading:N,showRefuges:C,setShowRefuges:p,showWaterPoints:b,setShowWaterPoints:j,createRoute:E,updateWaypointCoordinates:I,addWaypoint:A,removeWaypoint:F,clearRoute:y,resetAll:T,findPOIsNearRoute:S,isRouteValid:i!==null,hasValidWaypoints:r.every(R=>R.lat!==0||R.lng!==0),totalWaypoints:r.length}}function Jt(){const{showToast:t}=be(),s=g.useRef(null),n=g.useRef(null),{hikingProfile:a,setHikingProfile:r,waypoints:o,setWaypoints:l,isLoop:x,setIsLoop:u,stageCount:m,setStageCount:i,currentRoute:f,refuges:h,waterPoints:c,isLoading:v,showRefuges:k,setShowRefuges:N,showWaterPoints:M,setShowWaterPoints:C,createRoute:p,resetAll:b}=Xt({onError:y=>{t(typeof y=="string"?y:"Une erreur est survenue","error")},onSuccess:y=>{y&&typeof y.totalDistance=="number"&&t(`Itinéraire créé: ${y.totalDistance.toFixed(1)}km`,"success")}}),j=g.useCallback(()=>{b(),setTimeout(()=>{n.current?.clearWaypoints()},50)},[b]),[w,d]=g.useState("planning"),S=y=>{r(y)},E=y=>{if(!y.lat||!y.lng||isNaN(Number(y.lat))||isNaN(Number(y.lng))){t(`❌ Erreur: Coordonnées invalides pour ${y.name||"ce refuge"}`,"error");return}n.current?.zoomToPOI(y.lat,y.lng,16),t(`📍 Zoom sur: ${y.name||"refuge"} (${y.type||"refuge"})`,"info")},I=y=>{if(!y.lat||!y.lng||y.lat===0||y.lng===0){t(`❌ Erreur: Coordonnées invalides pour ${y.name||"ce point d'eau"}`,"error");return}n.current?.zoomToPOI(y.lat,y.lng,16),t(`📍 Zoom sur: ${y.name||"point d'eau"} (${y.quality||"qualité inconnue"})`,"info")},A=(y,T)=>{try{const R=new Blob([y],{type:"application/gpx+xml"}),$=URL.createObjectURL(R),D=document.createElement("a");D.href=$,D.download=T,document.body.appendChild(D),D.click(),document.body.removeChild(D),URL.revokeObjectURL($),t("Fichier GPX téléchargé avec succès!","success")}catch{t("Erreur lors du téléchargement du fichier GPX","error")}},F=g.useCallback(async(y,T)=>{try{const R=y,$=T;l(D=>{const P=[...D];if(P.length===2&&P[0].lat===0&&P[0].lng===0)return P[0]={...P[0],lat:R,lng:$,name:"Point A"},s.current="Point A (départ) défini",P;if(P.length===2&&P[1].lat===0&&P[1].lng===0)return P[1]={...P[1],lat:R,lng:$,name:"Point B"},s.current="Point B (arrivée) défini",P;if(P.length>=2){const W=P[P.length-1],Q=P.length-1;return P[P.length-1]={id:`waypoint-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,lat:R,lng:$,name:`Étape ${Q}`},P.push({...W,name:"Point B"}),s.current=`Étape ${Q} ajoutée`,P}return P})}catch{t("Erreur lors du placement du point","error")}},[l,t]);return ye.useEffect(()=>{s.current&&(t(s.current,"success"),s.current=null)},[o,t]),e.jsxs("div",{className:"min-h-screen bg-gradient-to-br from-emerald-400 via-teal-500 to-green-600 relative",children:[e.jsx(Te,{}),e.jsx("div",{className:"bg-gradient-to-r from-emerald-500 to-teal-600 text-white py-4 md:py-8",children:e.jsxs("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8",children:[e.jsx("h1",{className:"text-2xl md:text-3xl font-bold mb-2",children:"Planificateur de randonnée"}),e.jsx("p",{className:"text-sm md:text-base text-emerald-100",children:"Créez des itinéraires multi-étapes avec profil altimétrique et export GPX"})]})}),e.jsx("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 md:py-6 pb-20 md:pb-6",children:e.jsxs("div",{className:"flex flex-col lg:grid lg:grid-cols-3 gap-4 md:gap-6",children:[e.jsxs("div",{className:"lg:col-span-1 space-y-4 md:space-y-6 order-2 lg:order-1",children:[e.jsx("div",{className:"bg-white/90 backdrop-blur-sm rounded-2xl p-3 md:p-4 shadow-xl border border-white/20",children:e.jsx("div",{className:"flex flex-wrap lg:flex-nowrap gap-1 bg-gray-100 rounded-2xl p-1",children:[{id:"planning",label:"Plan",icon:e.jsx(Le,{className:"w-4 h-4"})},{id:"profile",label:"Profil",icon:e.jsx(Fe,{className:"w-4 h-4"})},{id:"poi",label:"POI",icon:e.jsx(et,{className:"w-4 h-4"})},{id:"gpx",label:"Import",icon:e.jsx(ae,{className:"w-4 h-4"})},{id:"export",label:"Export",icon:e.jsx(Qe,{className:"w-4 h-4"})}].map(y=>e.jsxs("button",{onClick:()=>d(y.id),className:`flex-1 lg:flex-auto flex flex-col lg:flex-row items-center justify-center gap-1 px-2 lg:px-4 py-2 rounded-xl text-xs font-medium transition-all min-w-0 ${w===y.id?"bg-white text-emerald-600 shadow-sm":"text-gray-600 hover:text-gray-800"}`,children:[e.jsx("span",{className:"text-emerald-600 flex-shrink-0",children:y.icon}),e.jsx("span",{className:"hidden lg:inline text-xs xl:text-sm font-medium whitespace-nowrap",children:y.label})]},y.id))})}),e.jsxs("div",{className:"bg-white/90 backdrop-blur-sm rounded-2xl p-3 md:p-4 shadow-xl border border-white/20",children:[w==="planning"&&e.jsxs("div",{className:"space-y-4",children:[e.jsx(Gt,{waypoints:o,onWaypointsChange:l,isLoop:x,onLoopChange:u,stageCount:m,onStageCountChange:i,hikingProfile:a,onProfileChange:S}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-2",children:[e.jsx("button",{onClick:p,disabled:v||o.length<2,className:"flex-1 px-4 py-3 bg-emerald-600 text-white rounded-xl hover:bg-emerald-700 disabled:opacity-50 disabled:cursor-not-allowed transition-all shadow-lg font-medium text-sm md:text-base flex items-center justify-center gap-2",children:v?"Création...":e.jsxs(e.Fragment,{children:[e.jsx(J,{className:"w-4 h-4"}),"Créer l'itinéraire"]})}),e.jsxs("button",{onClick:j,className:"px-4 py-3 bg-gray-600 text-white rounded-xl hover:bg-gray-700 transition-all shadow-lg sm:w-auto w-full flex items-center justify-center gap-2",children:[e.jsx(nt,{className:"w-4 h-4"}),"Reset"]})]})]}),w==="profile"&&e.jsx(at,{route:f,showStages:!0}),w==="poi"&&e.jsx(zt,{refuges:h,waterPoints:c,showRefuges:k,showWaterPoints:M,onToggleRefuges:N,onToggleWaterPoints:C,onRefugeSelect:E,onWaterPointSelect:I}),w==="gpx"&&e.jsx(Ft,{onGPXImported:(y,T)=>{l(y),t(T?.name?`✅ ${T.name} importé avec ${y.length} points`:`✅ GPX importé avec ${y.length} points`,"success")},onError:y=>{t(`❌ Erreur GPX: ${y}`,"error")}}),w==="export"&&e.jsx(Mt,{route:f,refuges:h,waterPoints:c,onExport:A})]})]}),e.jsxs("div",{className:"lg:col-span-2 space-y-4 md:space-y-6 relative order-1 lg:order-2",children:[e.jsx("div",{className:"bg-white/90 backdrop-blur-sm rounded-2xl shadow-xl border border-white/20 overflow-hidden",children:e.jsx("div",{className:"h-64 sm:h-80 md:h-[60vh] lg:h-[calc(100vh-160px)] xl:h-[calc(100vh-255px)] relative",children:e.jsx(ue,{ref:n,route:f,refuges:h,waterPoints:c,showRefuges:k,showWaterPoints:M,onToggleRefuges:N,onToggleWaterPoints:C,waypoints:o,onMapClick:F})})}),f&&e.jsxs("div",{className:"bg-white/90 backdrop-blur-sm rounded-2xl p-4 md:p-6 shadow-xl border border-white/20",children:[e.jsx("h2",{className:"text-base md:text-lg font-semibold text-gray-800 mb-3 md:mb-4 flex items-center gap-2",children:"📊 Résumé de l'itinéraire"}),e.jsxs("div",{className:"grid grid-cols-2 lg:grid-cols-4 gap-3 md:gap-4 mb-4",children:[e.jsxs("div",{className:"text-center bg-emerald-50 rounded-xl p-3 md:p-4",children:[e.jsx("div",{className:"text-xl md:text-2xl font-bold text-emerald-600",children:f.totalDistance?f.totalDistance.toFixed(1):"0"}),e.jsx("div",{className:"text-xs md:text-sm text-gray-600",children:"km"})]}),e.jsxs("div",{className:"text-center bg-green-50 rounded-xl p-3 md:p-4",children:[e.jsxs("div",{className:"text-xl md:text-2xl font-bold text-green-600",children:["+",f.totalAscent||0]}),e.jsx("div",{className:"text-xs md:text-sm text-gray-600",children:"m"})]}),e.jsxs("div",{className:"text-center bg-orange-50 rounded-xl p-3 md:p-4",children:[e.jsxs("div",{className:"text-xl md:text-2xl font-bold text-orange-600",children:["-",f.totalDescent||0]}),e.jsx("div",{className:"text-xs md:text-sm text-gray-600",children:"m"})]}),e.jsxs("div",{className:"text-center bg-blue-50 rounded-xl p-3 md:p-4",children:[e.jsx("div",{className:"text-xl md:text-2xl font-bold text-blue-600",children:f.stages?f.stages.length:0}),e.jsxs("div",{className:"text-xs md:text-sm text-gray-600",children:["étape",f.stages&&f.stages.length>1?"s":""]})]})]}),f.stages&&f.stages.length>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsx("h3",{className:"font-medium text-gray-700 flex items-center gap-2 text-sm md:text-base",children:"🗺️ Détail des étapes:"}),e.jsx("div",{className:"max-h-40 md:max-h-none overflow-y-auto space-y-2",children:f.stages.map(y=>e.jsxs("div",{className:"flex flex-col sm:flex-row sm:justify-between sm:items-center p-3 bg-gray-50 rounded-xl gap-2",children:[e.jsx("span",{className:"font-medium text-sm md:text-base",children:y.name||"Étape"}),e.jsxs("div",{className:"flex flex-wrap gap-2 text-xs",children:[e.jsxs("span",{className:"bg-emerald-100 text-emerald-700 px-2 py-1 rounded-lg font-medium",children:[y.distance?y.distance.toFixed(1):"0","km"]}),e.jsxs("span",{className:"bg-green-100 text-green-700 px-2 py-1 rounded-lg font-medium",children:["+",y.ascent||0,"m"]}),e.jsxs("span",{className:"bg-orange-100 text-orange-700 px-2 py-1 rounded-lg font-medium",children:["-",y.descent||0,"m"]})]})]},y.id))})]})]})]})]})}),e.jsx("div",{className:"fixed bottom-4 right-4 lg:hidden z-50",children:e.jsx("button",{onClick:p,disabled:v||o.length<2,className:"w-14 h-14 bg-emerald-600 hover:bg-emerald-700 disabled:opacity-50 disabled:cursor-not-allowed text-white rounded-full shadow-lg transition-all duration-200 flex items-center justify-center",children:v?e.jsx("div",{className:"animate-spin rounded-full h-6 w-6 border-b-2 border-white"}):e.jsx(J,{className:"text-xl"})})})]})}export{Jt as default};
